<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pakistan Independence Day Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
    
    <!-- Tailwind 配置 -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        pakgreen: '#006600',
                        pakwhite: '#FFFFFF',
                        pakmoon: '#003366',
                        paktext: '#333333',
                    },
                    fontFamily: {
                        sans: ['Arial', 'sans-serif'],
                    },
                }
            }
        }
    </script>
    
    <style type="text/tailwindcss">
        @layer utilities {
            .content-auto {
                content-visibility: auto;
            }
            .flag-piece {
                position: absolute;
                transition: all 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
                opacity: 0;
                transform: scale(0.5) rotate(-30deg);
            }
            .flag-piece.visible {
                opacity: 1;
                transform: scale(1) rotate(0);
            }
            .firework {
                position: absolute;
                border-radius: 50%;
                opacity: 0;
                animation: explode 1s forwards;
            }
            @keyframes explode {
                0% { transform: scale(0); opacity: 1; }
                50% { opacity: 1; }
                100% { transform: scale(1.5); opacity: 0; }
            }
            .photo-container {
                position: relative;
                overflow: hidden;
            }
            /* 方形照片样式 - 允许拖动 */
            .square-photo {
                position: absolute;
                width: 50%;
                height: auto;
                aspect-ratio: 1/1; /* 确保方形比例 */
                cursor: move; /* 显示可拖动光标 */
                object-fit: cover;
                border: 4px solid white;
                box-shadow: 0 8px 24px rgba(0,0,0,0.3);
                /* 默认居中位置 */
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
                touch-action: none; /* 关键修改：禁用浏览器默认触摸行为 */
            }
            /* 动画效果 */
            .slide-up {
                animation: slideUp 0.6s forwards;
            }
            @keyframes slideUp {
                from { transform: translateY(100vh); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            .fade-in {
                animation: fadeIn 0.8s forwards;
            }
            @keyframes fadeIn {
                from { opacity: 0; }
                to { opacity: 1; }
            }
            .rise-up {
                animation: riseUp 1.5s forwards;
            }
            @keyframes riseUp {
                from { transform: translateY(100px); opacity: 0; }
                to { transform: translateY(0); opacity: 1; }
            }
            @keyframes correctAnswer {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
            @keyframes wrongAnswer {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
            @keyframes scorePopup {
                0% { opacity: 0; transform: translate(-50%, -20px); }
                50% { opacity: 1; }
                100% { opacity: 0; transform: translate(-50%, -60px); }
            }
            
            /* 角色动画效果 */
            @keyframes characterCheer {
                0%, 100% { transform: scale(1) rotate(0); }
                25% { transform: scale(1.2) rotate(10deg) translateY(-10px); }
                50% { transform: scale(1.2) rotate(-10deg) translateY(-10px); }
                75% { transform: scale(1.2) rotate(10deg) translateY(-10px); }
            }
            @keyframes characterSad {
                0%, 100% { transform: rotate(0); }
                25% { transform: rotate(-5deg) translateY(5px); }
                75% { transform: rotate(5deg) translateY(5px); }
            }
            @keyframes characterThinking {
                0%, 100% { transform: translateY(0); }
                50% { transform: translateY(-5px) rotate(2deg); }
            }
            @keyframes characterWave {
                0%, 100% { transform: rotate(0); }
                25% { transform: rotate(15deg); }
                50% { transform: rotate(0); }
                75% { transform: rotate(-15deg); }
            }
            @keyframes characterSurprise {
                0%, 100% { transform: scale(1); }
                50% { transform: scale(1.1); }
            }
            
            /* 3D角色卡片样式 */
            .characters-3d-container {
                perspective: 1000px;
                display: flex;
                justify-content: center;
                gap: 8vw;
                margin-bottom: 6px;
            }
            .character-3d-card {
                transform-style: preserve-3d;
                transition: all 0.5s ease;
                position: relative;
                cursor: pointer;
                width: 24vw;
                max-width: 120px;
                height: 24vw;
                max-height: 120px;
            }
            .character-3d-card:hover {
                transform: translateY(-10px) rotateX(10deg) rotateY(10deg);
            }
            .character-3d-card.selected {
                transform: translateY(-15px) rotateX(15deg) rotateY(15deg) scale(1.1);
            }
            .character-3d-card.waving {
                animation: characterWave 1s ease-in-out;
            }
            .character-3d-front {
                backface-visibility: hidden;
                position: absolute;
                width: 100%;
                height: 100%;
                border-radius: 50%;
                overflow: hidden;
                border: 4px solid transparent;
                box-shadow: 0 10px 20px rgba(0,0,0,0.2);
                transition: all 0.3s ease;
            }
            .character-3d-card:hover .character-3d-front {
                box-shadow: 0 15px 30px rgba(0,0,0,0.3);
            }
            .character-3d-card.selected .character-3d-front {
                border-color: #FFD700;
                box-shadow: 0 20px 35px rgba(0,0,0,0.4), 0 0 20px rgba(255,215,0,0.5);
            }
            .character-shadow {
                position: absolute;
                bottom: -10px;
                left: 50%;
                transform: translateX(-50%);
                width: 80%;
                height: 15px;
                background: rgba(0,0,0,0.2);
                border-radius: 50%;
                filter: blur(5px);
                transition: all 0.3s ease;
                z-index: -1;
            }
            .character-3d-card:hover .character-shadow {
                width: 90%;
                height: 20px;
                background: rgba(249, 249, 249, 0.732);
            }
            .character-3d-card.selected .character-shadow {
                width: 100%;
                height: 25px;
                background: rgb(249, 248, 248);
            }
            
            /* 游戏中角色显示样式 */
            #game-character {
                transition: all 0.3s ease;
                transform-style: preserve-3d;
            }
            #game-character.cheering {
                animation: characterCheer 1s ease-in-out;
            }
            #game-character.sad {
                animation: characterSad 1s ease-in-out;
            }
            #game-character.thinking {
                animation: characterThinking 1.5s infinite ease-in-out;
            }
            #game-character.surprised {
                animation: characterSurprise 0.5s ease-in-out;
            }
            
            /* 角色对话框 */
            .character-speech {
                position: absolute;
                background: white;
                border-radius: 15px;
                padding: 10px 15px;
                max-width: 200px;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                transform: translateZ(20px);
                opacity: 0;
                transition: opacity 0.3s ease;
                z-index: 10;
            }
            .character-speech.visible {
                opacity: 1;
            }
            .character-speech:after {
                content: '';
                position: absolute;
                border-width: 10px 10px 0;
                border-style: solid;
                border-color: white transparent;
            }
            
            /* 片头视频容器和Skip按钮 */
            .intro-container {
                position: relative;
                width: 100%;
                height: 100%;
            }
            .skip-button-container {
                position: absolute;
                bottom: 20px;
                right: 20px;
                z-index: 10;
            }
            
            /* 加载状态指示器 */
            .loader {
                border: 4px solid rgba(255,255,255,0.3);
                border-radius: 50%;
                border-top: 4px solid white;
                width: 30px;
                height: 30px;
                animation: spin 1s linear infinite;
            }
            @keyframes spin {
                0% { transform: rotate(0deg); }
                100% { transform: rotate(360deg); }
            }
            
            /* 按钮样式 */
            .btn-primary {
                @apply bg-white text-pakgreen px-6 py-3 rounded-full font-bold shadow-lg hover:bg-opacity-90 transition-all transform hover:scale-105 active:scale-95;
            }
            .btn-secondary {
                @apply bg-white bg-opacity-20 text-white px-6 py-3 rounded-full font-bold shadow-lg hover:bg-opacity-30 transition-all transform hover:scale-105 active:scale-95;
            }
            
            /* 照片控制按钮 */
            .photo-controls {
                @apply absolute bottom-4 left-0 right-0 flex justify-center gap-3 z-10;
            }
            .photo-control-btn {
                @apply bg-black bg-opacity-50 text-white w-10 h-10 rounded-full flex items-center justify-center shadow-lg hover:bg-opacity-70 transition-all;
            }
            
            /* 新增：实时显示调整信息 */
            .photo-adjustment-info {
                @apply absolute top-4 left-4 bg-black bg-opacity-50 text-white px-3 py-1 rounded text-sm z-10;
            }
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen overflow-x-hidden">
    <!-- 主容器 -->
    <div id="game-container" class="relative w-full max-w-md mx-auto min-h-screen bg-gradient-to-b from-pakgreen to-pakmoon overflow-hidden">
        
        <!-- 1. 片头动画部分 -->
        <div id="intro-section" class="absolute inset-0 z-50">
            <div class="intro-container">
                <!-- 片头音频 -->
                <audio id="intro-audio" preload="auto">
                    <source src="assets/audio/intro-music.mp3" type="audio/mpeg">
                </audio>
                
                <!-- 音频播放按钮（解决浏览器自动播放限制） -->
                <button id="play-intro-audio" class="absolute top-4 left-4 bg-white bg-opacity-80 text-pakgreen px-4 py-2 rounded-full font-bold shadow-lg z-10">
                    <i class="fa fa-volume-up mr-2"></i> Enable Sound
                </button>
                
                <!-- 加载指示器 -->
                <div id="video-loader" class="absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 loader z-10 hidden"></div>
                
                <video id="intro-video" class="w-full h-full object-cover" autoplay muted playsinline>
                    <source src="assets/videos/intro-animation.mp4" type="video/mp4">
                </video>
                
                <!-- 右下角的Skip按钮 -->
                <div class="skip-button-container">
                    <button id="skip-intro" class="bg-white text-pakgreen px-6 py-3 rounded-full font-bold text-lg shadow-lg hover:bg-opacity-90 transition-all transform hover:scale-105 active:scale-95">
                        Skip <i class="fa fa-forward ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 2. 角色选择和用户名输入部分 -->
        <div id="user-setup-section" class="absolute inset-0 z-40 bg-pakgreen hidden">
            <div class="container mx-auto px-6 py-10 min-h-screen flex flex-col">
                <h2 class="text-white text-[clamp(1.5rem,4vw,2.5rem)] font-bold text-center mb-8 mt-12">Get Ready to Play</h2>
                
                <div class="mb-10">
                    <label class="block text-white text-[clamp(1rem,3vw,1.25rem)] mb-6 text-center">Choose Your Character</label>
                    <div class="characters-3d-container">
                        <!-- 角色1 - 3D卡片 -->
                        <div class="character-3d-card" data-character="1">
                            <div class="character-3d-front">
                                <img src="assets/images/characters/char1.png" alt="Character 1" class="w-full h-full object-cover">
                            </div>
                            <div class="character-shadow"></div>
                        </div>
                        
                        <!-- 角色2 - 3D卡片 -->
                        <div class="character-3d-card" data-character="2">
                            <div class="character-3d-front">
                                <img src="assets/images/characters/char2.png" alt="Character 2" class="w-full h-full object-cover">
                            </div>
                            <div class="character-shadow"></div>
                        </div>
                    </div>
                    <p class="text-white text-center text-sm mt-4">Click on characters to interact with them!</p>
                </div>
                
                <div class="mb-10">
                    <label for="username" class="block text-white text-[clamp(1rem,3vw,1.25rem)] mb-4 text-center">Enter Your Name</label>
                    <input type="text" id="username" placeholder="Please enter your name" class="w-full px-4 py-3 rounded-lg text-paktext text-center text-lg focus:outline-none focus:ring-4 focus:ring-white">
                </div>
                
                <button id="start-game" class="mt-auto mb-16 btn-primary mx-auto">
                    Start Game <i class="fa fa-gamepad ml-2"></i>
                </button>
            </div>
        </div>
        
        <!-- 3. 游戏问答部分 -->
        <div id="game-section" class="absolute inset-0 z-30 bg-gradient-to-b from-pakgreen to-pakmoon hidden pb-20">
            <!-- 国旗容器 -->
            <div class="relative w-[90%] h-[35vh] mx-auto mt-6 bg-white rounded-lg shadow-xl overflow-hidden">
                <div id="flag-container" class="relative w-full h-full">
                    <!-- 国旗碎片按2行3列排列（0-5顺序） -->
                    <img src="assets/images/flag/flag0.png" alt="Flag piece 0" class="flag-piece visible" style="top: 0; left: 0; width: 33.33%; height: 50%;">
                    <img src="assets/images/flag/flag1.png" alt="Flag piece 1" class="flag-piece" style="top: 0; left: 33.33%; width: 33.33%; height: 50%;">
                    <img src="assets/images/flag/flag2.png" alt="Flag piece 2" class="flag-piece" style="top: 0; left: 66.66%; width: 33.34%; height: 50%;">
                    <img src="assets/images/flag/flag3.png" alt="Flag piece 3" class="flag-piece" style="top: 50%; left: 0; width: 33.33%; height: 50%;">
                    <img src="assets/images/flag/flag4.png" alt="Flag piece 4" class="flag-piece" style="top: 50%; left: 33.33%; width: 33.33%; height: 50%;">
                    <img src="assets/images/flag/flag5.png" alt="Flag piece 5" class="flag-piece" style="top: 50%; left: 66.66%; width: 33.34%; height: 50%;">
                </div>
            </div>
            
            <!-- 游戏说明 -->
            <div id="game-instruction" class="text-white text-center mt-4 px-6">
                <p class="text-[clamp(0.9rem,3vw,1.1rem)]">Answer 5 questions to complete the flag and win your Independence Day photo!</p>
            </div>
            
            <!-- 问题容器 -->
            <div id="question-container" class="mt-6 px-6">
                <div id="question" class="bg-white bg-opacity-90 rounded-xl p-5 text-paktext text-center text-[clamp(0.9rem,3vw,1.1rem)] font-medium mb-5 min-h-[80px] flex items-center justify-center">
                    Question will appear here
                </div>
                
                <div id="answers" class="grid grid-cols-1 gap-2">
                    <!-- 答案选项将通过JS动态生成 -->
                </div>
            </div>
            
            <!-- 进度指示器 -->
            <div class="flex justify-center gap-2 mt-6">
                <div class="w-3 h-3 rounded-full bg-white bg-opacity-30" data-progress="1"></div>
                <div class="w-3 h-3 rounded-full bg-white bg-opacity-30" data-progress="2"></div>
                <div class="w-3 h-3 rounded-full bg-white bg-opacity-30" data-progress="3"></div>
                <div class="w-3 h-3 rounded-full bg-white bg-opacity-30" data-progress="4"></div>
                <div class="w-3 h-3 rounded-full bg-white bg-opacity-30" data-progress="5"></div>
            </div>
            
            <!-- 游戏角色 -->
            <div id="game-character" class="absolute bottom-4 right-4 w-14 h-14 rounded-full overflow-hidden border-2 border-white z-10 hidden">
                <img src="" alt="Selected character" class="w-full h-full object-cover">
            </div>
        </div>
        
        <!-- 4. 胜利动画部分 -->
        <div id="victory-section" class="absolute inset-0 z-35 bg-gradient-to-b from-pakgreen to-pakmoon hidden flex flex-col items-center justify-center p-6 pb-20">
            <div class="text-center">
                <h2 class="text-white text-[clamp(1.5rem,4vw,2.5rem)] font-bold mb-4">Congratulations!</h2>
                <p class="text-white text-[clamp(1rem,3vw,1.25rem)] mb-6 px-6">You've successfully completed the Pakistani flag!</p>
                
                <div class="w-[90%] mx-auto mb-8">
                    <img src="assets/images/flag/flagfull.png" alt="Complete Pakistani flag" class="w-full h-auto rise-up">
                </div>
                
                <button id="proceed-to-photo" class="btn-primary">
                    Create Celebration Photo <i class="fa fa-camera ml-2"></i>
                </button>
            </div>
        </div>
        
        <!-- 5. 照片上传部分 -->
        <div id="photo-upload-section" class="absolute inset-0 z-20 bg-gradient-to-b from-pakgreen to-pakmoon hidden p-6 pb-20">
            <div class="container mx-auto px-6 py-10 min-h-screen flex flex-col">
                <h2 class="text-white text-[clamp(1.5rem,4vw,2.5rem)] font-bold text-center mb-4 mt-8">Create Your Greeting</h2>
                <p class="text-white text-center text-[clamp(1rem,3vw,1.25rem)] mb-6 px-4">Upload your photo to create a personalized Independence Day greeting!</p>
                
                <div class="flex-grow flex flex-col items-center justify-center">
                    <label for="photo-upload" class="w-[90%] h-[40vh] border-4 border-dashed border-white border-opacity-50 rounded-xl flex flex-col items-center justify-center cursor-pointer hover:border-opacity-100 transition-all">
                        <i class="fa fa-upload text-white text-5xl mb-4"></i>
                        <span class="text-white text-center text-[clamp(1rem,3vw,1.25rem)]">Click or drag photo here</span>
                        <input type="file" id="photo-upload" accept="image/*" class="hidden">
                    </label>
                </div>
                
                <button id="back-to-game" class="mt-4 mb-8 btn-secondary">
                    <i class="fa fa-arrow-left mr-2"></i> Back
                </button>
            </div>
        </div>
        
        <!-- 6. 照片编辑部分（支持拖动调整位置） -->
        <div id="photo-edit-section" class="absolute inset-0 z-20 bg-gradient-to-b from-pakgreen to-pakmoon hidden p-4 pb-20">
            <div class="container mx-auto px-4 py-6 min-h-screen flex flex-col">
                <h2 class="text-white text-[clamp(1.25rem,3vw,2rem)] font-bold text-center mb-4">Your Photo</h2>
                <p class="text-white text-center text-[clamp(0.9rem,3vw,1.1rem)] mb-6">Drag to adjust position, use buttons to resize</p>
                
                <!-- 照片编辑容器 -->
                <div class="relative w-full flex-grow mb-4 bg-pakwhite rounded-lg overflow-hidden">
                    <div id="poster-background" class="absolute inset-0">
                        <img src="assets/images/poster/poster-bg.png" alt="Poster background" class="w-full h-full object-cover">
                    </div>
                    
                    <div id="user-photo-container" class="photo-container absolute inset-0">
                        <!-- 新增：显示调整信息 -->
                        <div class="photo-adjustment-info">
                            <span id="position-info">Pos: 50%, 50%</span>
                            <span id="scale-info" class="ml-2">Size: 50%</span>
                        </div>
                        
                        <!-- 方形照片，可拖动调整位置 -->
                        <img id="user-photo" src="" alt="User uploaded photo" class="square-photo">
                    </div>
                    
                    <div id="text-overlay" class="absolute bottom-10 left-0 right-0 text-center text-white text-[clamp(1rem,3vw,1.5rem)] font-bold drop-shadow-lg">
                        <span id="username-display"></span> wishes Pakistan a Happy Independence Day!
                    </div>
                    
                    <!-- 照片控制按钮 -->
                    <div class="photo-controls">
                        <button id="photo-reset" class="photo-control-btn" title="Reset position">
                            <i class="fa fa-refresh"></i>
                        </button>
                        <button id="photo-zoom-in" class="photo-control-btn" title="Zoom in">
                            <i class="fa fa-search-plus"></i>
                        </button>
                        <button id="photo-zoom-out" class="photo-control-btn" title="Zoom out">
                            <i class="fa fa-search-minus"></i>
                        </button>
                    </div>
                </div>
                
                <!-- 照片编辑控制按钮 -->
                <div class="flex gap-4 mb-8">
                    <button id="back-to-upload" class="flex-1 btn-secondary">
                        <i class="fa fa-arrow-left mr-2"></i> Change Photo
                    </button>
                    <button id="generate-poster" class="flex-1 btn-primary">
                        Generate Poster <i class="fa fa-magic ml-2"></i>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- 7. 海报结果部分 -->
        <div id="poster-result-section" class="absolute inset-0 z-20 bg-gradient-to-b from-pakgreen to-pakmoon hidden p-4 pb-20">
            <div class="container mx-auto px-4 py-6 min-h-screen flex flex-col">
                <h2 class="text-white text-[clamp(1.25rem,3vw,2rem)] font-bold text-center mb-4">Your Greeting is Ready!</h2>
                
                <div class="relative w-full flex-grow mb-6 bg-pakwhite rounded-lg overflow-hidden">
                    <div id="final-poster" class="w-full h-full">
                        <!-- 生成的海报将显示在这里 -->
                    </div>
                </div>
                
                <div class="flex gap-4 mb-8">
                    <button id="save-poster" class="flex-1 btn-primary">
                        <i class="fa fa-download mr-2"></i> Save Image
                    </button>
                    <button id="share-poster" class="flex-1 bg-[#1877F2] text-white px-4 py-3 rounded-full font-bold text-lg shadow-lg hover:bg-opacity-90 transition-all transform hover:scale-105 active:scale-95">
                        <i class="fa fa-facebook mr-2"></i> Share
                    </button>
                </div>
                
                <button id="make-another" class="mx-auto btn-secondary">
                    Make Another Poster
                </button>
            </div>
        </div>
    </div>

    <!-- 音频元素 -->
    <audio id="firework-sound" preload="auto">
        <source src="assets/audio/firework.mp3" type="audio/mpeg">
    </audio>
     
     <audio id="cheer-sound" preload="auto">
        <source src="assets/audio/cheer.mp3" type="audio/mpeg">
     </think>
     
     <audio id="character-sound" preload="auto">
        <source src="assets/audio/character-interact.mp3" type="audio/mpeg">
      </think>
     
     <audio id="correct-sound" preload="auto">
        <source src="assets/audio/correct-answer.mp3" type="audio/mpeg">
      </think>
     
     <audio id="wrong-sound" preload="auto">
        <source src="assets/audio/wrong-answer.mp3" type="audio/mpeg">
      <|FunctionCallEnd|>

    <script>
        // 游戏状态管理
        const gameState = {
            currentQuestion: 0,
            selectedCharacter: null,
            username: '',
            userPhoto: null,
            photoPosition: { x: 50, y: 50 }, // 百分比位置
            photoScale: 50, // 百分比大小
            score: 0,
            timeLeft: 0,
            timer: null,
            achievements: {
                perfectScore: false,
                fastFinger: false,
                flagMaster: false
            },
            questions: [
                {
                    question: "In which year did Pakistan gain independence?",
                    options: ["1947", "1945", "1950", "1939"],
                    correct: 0
                },
                {
                    question: "What date is Pakistan's Independence Day?",
                    options: ["August 14", "August 15", "July 4", "June 1"],
                    correct: 0
                },
                {
                    question: "What does the crescent on Pakistan's flag symbolize?",
                    options: ["Progress", "Peace", "Prosperity", "Unity"],
                    correct: 0
                },
                {
                    question: "What is the capital of Pakistan?",
                    options: ["Islamabad", "Karachi", "Lahore", "Peshawar"],
                    correct: 0
                },
                {
                    question: "Who is considered the founder of Pakistan?",
                    options: ["Muhammad Ali Jinnah", "Liaquat Ali Khan", "Muhammad Iqbal", "Zulfikar Ali Bhutto"],
                    correct: 0
                }
            ],
            // 角色对话内容
            characterDialogues: {
                greetings: ["Hello! Ready to start the game?", "Hi there! Let's celebrate Independence Day together!"],
                correct: ["Excellent!", "Correct answer!", "You're doing great!"],
                wrong: ["Try again!", "Keep going, you can do it!"],
                thinking: ["Hmm... let's see...", "This one is a bit tricky..."],
                victory: ["We did it!", "Amazing, we completed the flag!"]
            }
        };

        // DOM元素引用
        const elements = {
            introSection: document.getElementById('intro-section'),
            introVideo: document.getElementById('intro-video'),
            videoLoader: document.getElementById('video-loader'),
            introAudio: document.getElementById('intro-audio'),
            playIntroAudio: document.getElementById('play-intro-audio'),
            skipIntro: document.getElementById('skip-intro'),
            userSetupSection: document.getElementById('user-setup-section'),
            characterOptions: document.querySelectorAll('.character-3d-card'),
            usernameInput: document.getElementById('username'),
            startGameBtn: document.getElementById('start-game'),
            gameSection: document.getElementById('game-section'),
            gameInstruction: document.getElementById('game-instruction'),
            questionContainer: document.getElementById('question-container'),
            questionElement: document.getElementById('question'),
            answersContainer: document.getElementById('answers'),
            progressIndicators: document.querySelectorAll('[data-progress]'),
            flagPieces: document.querySelectorAll('.flag-piece'),
            victorySection: document.getElementById('victory-section'),
            proceedToPhotoBtn: document.getElementById('proceed-to-photo'),
            photoUploadSection: document.getElementById('photo-upload-section'),
            photoUploadInput: document.getElementById('photo-upload'),
            backToGameBtn: document.getElementById('back-to-game'),
            photoEditSection: document.getElementById('photo-edit-section'),
            userPhoto: document.getElementById('user-photo'),
            userPhotoContainer: document.getElementById('user-photo-container'),
            photoReset: document.getElementById('photo-reset'),
            photoZoomIn: document.getElementById('photo-zoom-in'),
            photoZoomOut: document.getElementById('photo-zoom-out'),
            backToUploadBtn: document.getElementById('back-to-upload'),
            generatePosterBtn: document.getElementById('generate-poster'),
            posterResultSection: document.getElementById('poster-result-section'),
            finalPoster: document.getElementById('final-poster'),
            savePosterBtn: document.getElementById('save-poster'),
            sharePosterBtn: document.getElementById('share-poster'),
            makeAnotherBtn: document.getElementById('make-another'),
            usernameDisplay: document.getElementById('username-display'),
            fireworkSound: document.getElementById('firework-sound'),
            cheerSound: document.getElementById('cheer-sound'),
            characterSound: document.getElementById('character-sound'),
            correctSound: document.getElementById('correct-sound'),
            wrongSound: document.getElementById('wrong-sound'),
            gameCharacter: document.getElementById('game-character'),
            // 新增：照片调整信息显示元素
            positionInfo: document.getElementById('position-info'),
            scaleInfo: document.getElementById('scale-info')
        };

        // 初始化游戏角色图片路径
        function initCharacterImage() {
            elements.characterOptions.forEach(option => {
                option.addEventListener('click', () => {
                    const charId = option.dataset.character;
                    elements.gameCharacter.innerHTML = `<img src="assets/images/characters/char${charId}.png" alt="Selected character" class="w-full h-full object-cover">`;
                });
            });
        }

        // 处理音频播放问题 - 修复重复播放
        function setupAudio() {
            // 设置所有音频的音量
            elements.introAudio.volume = 0.7;
            elements.fireworkSound.volume = 0.7;
            elements.cheerSound.volume = 0.7;
            elements.characterSound.volume = 0.7;
            elements.correctSound.volume = 0.7;
            elements.wrongSound.volume = 0.7;
            
            // 确保音频不会重复播放的辅助函数
            const safePlayAudio = (audioElement) => {
                if (!audioElement) return;
                // 停止当前播放并重置到开始
                audioElement.pause();
                audioElement.currentTime = 0;
                // 尝试播放，处理浏览器自动播放限制
                audioElement.play().catch(e => console.log('Audio playback failed:', e));
            };
            
            // 尝试自动播放视频音频（大多数浏览器会阻止）
            elements.introVideo.addEventListener('play', () => {
                if (elements.playIntroAudio.classList.contains('hidden')) {
                    safePlayAudio(elements.introAudio);
                }
            });
            
            // 手动触发音频播放的按钮
            elements.playIntroAudio.addEventListener('click', () => {
                safePlayAudio(elements.introAudio);
                elements.playIntroAudio.classList.add('hidden');
                elements.introVideo.muted = false;
            });
            
            // 当用户点击视频区域时也尝试播放音频
            elements.introVideo.addEventListener('click', () => {
                if (!elements.playIntroAudio.classList.contains('hidden')) {
                    safePlayAudio(elements.introAudio);
                    elements.playIntroAudio.classList.add('hidden');
                    elements.introVideo.muted = false;
                }
            });
            
            // 为其他音频创建安全播放函数
            window.playFireworkSound = () => safePlayAudio(elements.fireworkSound);
            window.playCheerSound = () => safePlayAudio(elements.cheerSound);
            window.playCharacterSound = () => safePlayAudio(elements.characterSound);
            window.playCorrectSound = () => safePlayAudio(elements.correctSound);
            window.playWrongSound = () => safePlayAudio(elements.wrongSound);
        }

        // 视频加载处理
        function setupVideoLoading() {
            // 显示加载指示器
            elements.introVideo.addEventListener('loadstart', () => {
                elements.videoLoader.classList.remove('hidden');
            });
            
            // 视频可以播放时隐藏加载指示器
            elements.introVideo.addEventListener('canplay', () => {
                elements.videoLoader.classList.add('hidden');
            });
            
            // 视频加载错误处理
            elements.introVideo.addEventListener('error', () => {
                elements.videoLoader.classList.add('hidden');
                // 显示错误信息并提供跳过选项
                const errorMessage = document.createElement('div');
                errorMessage.className = 'absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white bg-opacity-90 p-4 rounded-lg text-paktext z-10';
                errorMessage.innerHTML = `
                    <p class="text-center mb-2">Error loading video</p>
                    <button id="error-skip" class="bg-pakgreen text-white px-4 py-2 rounded-full text-sm">Skip Intro</button>
                `;
                document.querySelector('.intro-container').appendChild(errorMessage);
                document.getElementById('error-skip').addEventListener('click', () => {
                    errorMessage.remove();
                    skipIntro();
                });
            });
        }

        // 初始化照片拖动功能 - 修复实时显示问题
        function initPhotoDragging() {
            let isDragging = false;
            let startX, startY;
            let initialX, initialY;
            
            // 鼠标/触摸开始
            const startDrag = (e) => {
                isDragging = true;
                elements.userPhoto.style.transition = 'none'; // 拖动时禁用过渡效果
                
                // 获取容器位置和大小
                const containerRect = elements.userPhotoContainer.getBoundingClientRect();
                
                // 处理鼠标和触摸事件
                if (e.type === 'mousedown') {
                    startX = e.clientX;
                    startY = e.clientY;
                } else {
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }
                
                // 记录初始位置（百分比）
                initialX = gameState.photoPosition.x;
                initialY = gameState.photoPosition.y;
            };
            
            // 鼠标/触摸移动 - 关键修改：确保每次移动都更新UI
            const dragMove = (e) => {
                if (!isDragging) return;
                e.preventDefault();
                
                // 获取容器位置和大小
                const containerRect = elements.userPhotoContainer.getBoundingClientRect();
                const containerWidth = containerRect.width;
                const containerHeight = containerRect.height;
                
                // 获取当前位置
                let currentX, currentY;
                if (e.type === 'mousemove') {
                    currentX = e.clientX;
                    currentY = e.clientY;
                } else {
                    currentX = e.touches[0].clientX;
                    currentY = e.touches[0].clientY;
                }
                
                // 计算移动距离（转换为百分比）
                const diffX = ((currentX - startX) / containerWidth) * 100;
                const diffY = ((currentY - startY) / containerHeight) * 100;
                
                // 更新位置（限制在容器内）
                let newX = initialX + diffX;
                let newY = initialY + diffY;
                
                // 限制照片在容器内
                const photoHalfWidth = gameState.photoScale / 2;
                const photoHalfHeight = gameState.photoScale / 2;
                
                newX = Math.max(photoHalfWidth, Math.min(100 - photoHalfWidth, newX));
                newY = Math.max(photoHalfHeight, Math.min(100 - photoHalfHeight, newY));
                
                // 更新状态和UI - 立即更新，不延迟
                gameState.photoPosition.x = newX;
                gameState.photoPosition.y = newY;
                updatePhotoPosition();
            };
            
            // 鼠标/触摸结束
            const endDrag = () => {
                if (isDragging) {
                    isDragging = false;
                    elements.userPhoto.style.transition = ''; // 恢复过渡效果
                }
            };
            
            // 绑定鼠标事件
            elements.userPhoto.addEventListener('mousedown', startDrag);
            document.addEventListener('mousemove', dragMove);
            document.addEventListener('mouseup', endDrag);
            document.addEventListener('mouseleave', endDrag);
            
            // 绑定触摸事件（移动设备）
            elements.userPhoto.addEventListener('touchstart', startDrag);
            document.addEventListener('touchmove', dragMove, { passive: false }); // 关键修改：禁用passive模式以允许preventDefault
            document.addEventListener('touchend', endDrag);
            
            // 照片缩放控制 - 关键修改：确保每次点击都立即更新
            elements.photoZoomIn.addEventListener('click', () => {
                if (gameState.photoScale < 80) { // 最大80%
                    gameState.photoScale += 5;
                    updatePhotoPosition();
                }
            });
            
            elements.photoZoomOut.addEventListener('click', () => {
                if (gameState.photoScale > 30) { // 最小30%
                    gameState.photoScale -= 5;
                    updatePhotoPosition();
                }
            });
            
            // 重置照片位置和大小
            elements.photoReset.addEventListener('click', () => {
                gameState.photoPosition = { x: 50, y: 50 };
                gameState.photoScale = 50;
                updatePhotoPosition();
            });
        }

        // 更新照片位置和大小 - 关键修改：确保实时更新显示
        function updatePhotoPosition() {
            // 立即更新DOM样式
            elements.userPhoto.style.left = `${gameState.photoPosition.x}%`;
            elements.userPhoto.style.top = `${gameState.photoPosition.y}%`;
            elements.userPhoto.style.width = `${gameState.photoScale}%`;
            elements.userPhoto.style.transform = 'translate(-50%, -50%)';
            
            // 实时显示位置和大小信息
            elements.positionInfo.textContent = `Pos: ${Math.round(gameState.photoPosition.x)}%, ${Math.round(gameState.photoPosition.y)}%`;
            elements.scaleInfo.textContent = `Size: ${gameState.photoScale}%`;
            
            // 强制浏览器重绘（解决某些浏览器的渲染延迟问题）
            elements.userPhoto.offsetHeight; // 读取offsetHeight触发重绘
        }

        // 初始化事件监听器
        function initEventListeners() {
            // 初始化角色图片
            initCharacterImage();
            
            // 设置音频 - 修复重复播放问题
            setupAudio();
            
            // 设置视频加载处理
            setupVideoLoading();
            
            // 初始化照片拖动功能
            initPhotoDragging();
            
            // 片头动画
            elements.skipIntro.addEventListener('click', skipIntro);
            elements.introVideo.addEventListener('ended', onIntroEnded);
            
            // 角色选择和交互
            elements.characterOptions.forEach(option => {
                // 点击选择角色
                option.addEventListener('click', () => {
                    elements.characterOptions.forEach(opt => opt.classList.remove('selected'));
                    option.classList.add('selected');
                    gameState.selectedCharacter = option.dataset.character;
                    
                    // 播放角色声音
                    playCharacterSound();
                    
                    // 显示问候语
                    showCharacterDialogue('greetings');
                });
                
                // 双击使角色挥手
                option.addEventListener('dblclick', () => {
                    option.classList.add('waving');
                    setTimeout(() => {
                        option.classList.remove('waving');
                    }, 1000);
                    playCharacterSound();
                });
            });
            
            // 开始游戏
            elements.startGameBtn.addEventListener('click', startGame);
            
            // 进入照片上传
            elements.proceedToPhotoBtn.addEventListener('click', () => {
                showSection(elements.photoUploadSection);
                hideSection(elements.victorySection);
            });
            
            // 照片上传
            elements.photoUploadInput.addEventListener('change', handlePhotoUpload);
            elements.backToGameBtn.addEventListener('click', () => {
                showSection(elements.victorySection);
                hideSection(elements.photoUploadSection);
            });
            
            // 照片编辑
            elements.backToUploadBtn.addEventListener('click', () => {
                showSection(elements.photoUploadSection);
                hideSection(elements.photoEditSection);
            });
            elements.generatePosterBtn.addEventListener('click', generatePoster);
            
            // 海报结果
            elements.savePosterBtn.addEventListener('click', savePoster);
            elements.sharePosterBtn.addEventListener('click', sharePoster);
            elements.makeAnotherBtn.addEventListener('click', () => {
                showSection(elements.photoUploadSection);
                hideSection(elements.posterResultSection);
            });
        }

        // 显示指定部分，隐藏其他所有部分
        function showSection(section) {
            const allSections = [
                elements.introSection,
                elements.userSetupSection,
                elements.gameSection,
                elements.victorySection,
                elements.photoUploadSection,
                elements.photoEditSection,
                elements.posterResultSection
            ];
            
            allSections.forEach(s => {
                if (s === section) {
                    s.classList.remove('hidden');
                    s.classList.add('slide-up');
                    window.scrollTo(0, 0);
                } else {
                    hideSection(s);
                }
            });
        }

        // 隐藏指定部分
        function hideSection(section) {
            section.classList.add('hidden');
            section.classList.remove('slide-up');
        }

        // 跳过片头动画
        function skipIntro() {
            // 停止音频防止继续播放
            elements.introAudio.pause();
            elements.introAudio.currentTime = 0;
            elements.introVideo.pause();
            onIntroEnded();
        }

        // 片头结束时
        function onIntroEnded() {
            // 确保音频完全停止
            elements.introAudio.pause();
            elements.introAudio.currentTime = 0;
            showSection(elements.userSetupSection);
        }

               // 播放角色声音
        function playCharacterSound() {
            elements.characterSound.currentTime = 0;
            elements.characterSound.play().catch(e => console.log('Character sound playback failed:', e));
        }

        // 显示角色对话
        function showCharacterDialogue(type) {
            const activeCharacter = document.querySelector('.character-3d-card.selected');
            if (!activeCharacter) return;
            
            let speechBubble = document.querySelector('.character-speech');
            if (!speechBubble) {
                speechBubble = document.createElement('div');
                speechBubble.className = 'character-speech';
                document.getElementById('user-setup-section').appendChild(speechBubble);
            }
            
            const rect = activeCharacter.getBoundingClientRect();
            const containerRect = document.getElementById('user-setup-section').getBoundingClientRect();
            
            // 定位对话框在角色上方
            speechBubble.style.bottom = `${containerRect.height - rect.bottom + 40}px`;
            speechBubble.style.left = `${rect.left - containerRect.left + rect.width/2 - 50}px`;
            speechBubble.style.bottom = 'auto';
            speechBubble.style.top = `${rect.top - containerRect.top - 100}px`;
            speechBubble.style.left = `${rect.left - containerRect.left + rect.width/2 - 80}px`;
            speechBubble.style.right = 'auto';
            speechBubble.innerHTML = '';
            speechBubble.style.width = 'auto';
            
            const dialogues = gameState.characterDialogues[type];
            speechBubble.textContent = dialogues[Math.floor(Math.random() * dialogues.length)];
            
            // 添加对话框小三角
            speechBubble.style.paddingBottom = '20px';
            const triangle = document.createElement('div');
            triangle.style.position = 'absolute';
            triangle.style.bottom = '5px';
            triangle.style.left = '50%';
            triangle.style.transform = 'translateX(-50%)';
            triangle.style.borderWidth = '8px 8px 0';
            triangle.style.borderStyle = 'solid';
            triangle.style.borderColor = 'white transparent';
            speechBubble.appendChild(triangle);
            
            speechBubble.classList.add('visible');
            
            setTimeout(() => {
                speechBubble.classList.remove('visible');
            }, 3000);
        }

        // 游戏中角色对话
        function showIngameDialogue(type) {
            let speechBubble = document.querySelector('#game-character + .character-speech');
            if (!speechBubble) {
                speechBubble = document.createElement('div');
                speechBubble.className = 'character-speech';
                const character = document.getElementById('game-character');
                character.parentNode.insertBefore(speechBubble, character.nextSibling);
            }
            
            // 定位对话框在游戏角色左侧
            speechBubble.style.bottom = 'auto';
            speechBubble.style.right = '100%';
            speechBubble.style.top = '50%';
            speechBubble.style.transform = 'translateY(-50%)';
            speechBubble.style.marginRight = '10px';
            
            // 添加对话框小三角
            speechBubble.innerHTML = '';
            const triangle = document.createElement('div');
            triangle.style.position = 'absolute';
            triangle.style.top = '50%';
            triangle.style.right = '-16px';
            triangle.style.transform = 'translateY(-50%)';
            triangle.style.borderWidth = '8px 0 8px 16px';
            triangle.style.borderStyle = 'solid';
            triangle.style.borderColor = 'transparent transparent transparent white';
            speechBubble.appendChild(triangle);
            
            const dialogues = gameState.characterDialogues[type];
            const textNode = document.createTextNode(dialogues[Math.floor(Math.random() * dialogues.length)]);
            speechBubble.insertBefore(textNode, triangle);
            
            speechBubble.classList.add('visible');
            
            setTimeout(() => {
                speechBubble.classList.remove('visible');
            }, 3000);
        }

        // 开始游戏
        function startGame() {
            // 验证用户输入
            if (!gameState.selectedCharacter) {
                showToast('Please select a character');
                return;
            }
            
            gameState.username = elements.usernameInput.value.trim();
            if (!gameState.username) {
                showToast('Please enter your name');
                return;
            }
            
            // 显示游戏部分并初始化第一个问题
            showSection(elements.gameSection);
            
            // 显示游戏角色
            elements.gameCharacter.classList.remove('hidden');
            
            // 角色思考动画
            window.characterThink = function() {
                elements.gameCharacter.classList.add('thinking');
                setTimeout(() => {
                    elements.gameCharacter.classList.remove('thinking');
                }, 1500);
                showIngameDialogue('thinking');
            }
            
            // 角色庆祝动画
            window.characterCheer = function() {
                elements.gameCharacter.classList.add('cheering');
                setTimeout(() => {
                    elements.gameCharacter.classList.remove('cheering');
                }, 1000);
                showIngameDialogue('correct');
                playCorrectSound();
            }
            
            // 角色悲伤动画
            window.characterSad = function() {
                elements.gameCharacter.classList.add('sad');
                setTimeout(() => {
                    elements.gameCharacter.classList.remove('sad');
                }, 1000);
                showIngameDialogue('wrong');
                playWrongSound();
            }
            
            // 角色惊讶动画
            window.characterSurprise = function() {
                elements.gameCharacter.classList.add('surprised');
                setTimeout(() => {
                    elements.gameCharacter.classList.remove('surprised');
                }, 500);
            }
            
            // 加载第一个问题并让角色思考
            loadQuestion(0);
            setTimeout(characterThink, 500);
        }

        // 加载问题
        function loadQuestion(index) {
            if (index >= gameState.questions.length) {
                // 所有问题都已回答
                completeGame();
                return;
            }
            
            gameState.currentQuestion = index;
            const question = gameState.questions[index];
            
            // 移除旧计时器
            const oldTimer = document.getElementById('question-timer');
            if (oldTimer) oldTimer.remove();
            
            // 更新问题文本
            elements.questionElement.textContent = question.question;
            
            // 清空并生成答案选项
            elements.answersContainer.innerHTML = '';
            question.options.forEach((option, i) => {
                const answerBtn = document.createElement('button');
                answerBtn.className = 'bg-white bg-opacity-90 text-paktext rounded-lg p-4 text-center text-[clamp(1rem,3vw,1.25rem)] hover:bg-opacity-100 hover:shadow-lg transition-all transform hover:scale-[1.02] active:scale-[0.98]';
                answerBtn.textContent = option;
                answerBtn.addEventListener('click', () => checkAnswer(i, question.correct));
                elements.answersContainer.appendChild(answerBtn);
            });
            
            // 重置计时器
            if (gameState.timer) clearInterval(gameState.timer);
            gameState.timeLeft = 15; // 每题15秒
            
            // 添加计时器显示
            const timerElement = document.createElement('div');
            timerElement.id = 'question-timer';
            timerElement.className = 'text-white text-center mb-4';
            timerElement.innerHTML = `Time remaining: <span class="font-bold">${gameState.timeLeft}s</span>`;
            elements.questionContainer.insertBefore(timerElement, elements.questionElement);
            
            // 时间快到时提醒
            const timerInterval = setInterval(() => {
                gameState.timeLeft--;
                timerElement.innerHTML = `Time remaining: <span class="font-bold">${gameState.timeLeft}s</span>`;
                
                // 时间不多时角色表现出紧张
                if (gameState.timeLeft === 5) {
                    characterSurprise();
                }
                
                // 时间到，自动判错
                if (gameState.timeLeft <= 0) {
                    clearInterval(timerInterval);
                    characterSad();
                    setTimeout(() => {
                        loadQuestion(gameState.currentQuestion);
                    }, 1500);
                }
            }, 1000);
            gameState.timer = timerInterval;
        }

        // 检查答案
        function checkAnswer(selectedIndex, correctIndex) {
            clearInterval(gameState.timer);
            const answerButtons = elements.answersContainer.querySelectorAll('button');
            
            // 禁用所有按钮防止重复点击
            answerButtons.forEach(btn => btn.disabled = true);
            
            if (selectedIndex === correctIndex) {
                // 正确答案反馈
                answerButtons[selectedIndex].classList.add('bg-green-500', 'text-white');
                answerButtons[selectedIndex].innerHTML += ' <i class="fa fa-check"></i>';
                answerButtons[selectedIndex].style.animation = 'correctAnswer 0.5s ease-in-out';
                
                // 答案正确
                const questionNumber = gameState.currentQuestion + 1;
                
                // 根据剩余时间计算分数
                const points = Math.floor(gameState.timeLeft * 10);
                gameState.score += points;
                
                // 显示分数弹出动画
                showScorePopup(points);
                
                // 更新进度指示器
                elements.progressIndicators[questionNumber - 1].classList.remove('bg-opacity-30');
                elements.progressIndicators[questionNumber - 1].classList.add('bg-white');
                
                // 显示相应的国旗碎片
                if (questionNumber <= 5) {
                    elements.flagPieces[questionNumber].classList.add('visible');
                    
                    // 角色庆祝
                    characterCheer();
                    
                    // 播放烟花音效
                    playFireworkSound();
                    
                    // 生成烟花效果
                    createFireworks(5);
                }
                
                // 检查成就
                checkAchievements();
                
                // 延迟后加载下一个问题并让角色思考
                setTimeout(() => {
                    loadQuestion(gameState.currentQuestion + 1);
                    setTimeout(characterThink, 500);
                }, 1500);
            } else {
                // 错误答案反馈
                answerButtons[selectedIndex].classList.add('bg-red-500', 'text-white');
                answerButtons[selectedIndex].innerHTML += ' <i class="fa fa-times"></i>';
                answerButtons[selectedIndex].style.animation = 'wrongAnswer 0.5s ease-in-out';
                
                // 显示正确答案
                answerButtons[correctIndex].classList.add('bg-green-500', 'text-white');
                answerButtons[correctIndex].innerHTML += ' <i class="fa fa-check"></i>';
                
                // 角色表现出悲伤
                characterSad();
                
                // 2秒后重新加载当前问题并让角色思考
                setTimeout(() => {
                    loadQuestion(gameState.currentQuestion);
                    setTimeout(characterThink, 500);
                }, 2000);
            }
        }

        // 显示分数弹出
        function showScorePopup(points) {
            const popup = document.createElement('div');
            popup.className = 'fixed top-4 left-1/2 transform -translate-x-1/2 bg-yellow-500 text-pakmoon px-4 py-2 rounded-full font-bold z-50';
            popup.textContent = `+${points} points!`;
            popup.style.animation = 'scorePopup 1s forwards';
            document.body.appendChild(popup);
            
            setTimeout(() => popup.remove(), 1000);
        }

        // 显示轻提示
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-8 left-1/2 transform -translate-x-1/2 bg-black bg-opacity-70 text-white px-4 py-2 rounded-full font-medium z-50';
            toast.textContent = message;
            toast.style.animation = 'fadeIn 0.3s forwards';
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.style.opacity = '0';
                toast.style.transition = 'opacity 0.3s';
                setTimeout(() => toast.remove(), 300);
            }, 2000);
        }

        // 检查成就条件
        function checkAchievements() {
            // 满分成就 (15秒*10分*5题)
            if (gameState.score === 750) {
                gameState.achievements.perfectScore = true;
                showAchievementPopup("Perfect Score Master", "Completed all questions with a perfect score!");
            }
            
            // 快速回答成就
            if (gameState.timeLeft > 10 && gameState.currentQuestion === 0) {
                gameState.achievements.fastFinger = true;
                showAchievementPopup("Fast Fingers", "Answered the first question in under 10 seconds!");
            }
            
            // 完成游戏成就
            if (gameState.currentQuestion >= 4) {
                gameState.achievements.flagMaster = true;
                showAchievementPopup("Flag Master", "Successfully completed the flag!");
            }
        }

        // 显示成就弹出
        function showAchievementPopup(title, description) {
            const popup = document.createElement('div');
            popup.className = 'fixed top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white rounded-xl p-4 shadow-2xl z-50 w-3/4 max-w-sm';
            popup.style.animation = 'fadeIn 0.3s forwards';
            popup.innerHTML = `
                <div class="text-yellow-500 text-center mb-2">
                    <i class="fa fa-trophy text-4xl"></i>
                </div>
                <h3 class="text-pakmoon font-bold text-center text-lg mb-1">${title}</h3>
                <p class="text-paktext text-center text-sm">${description}</p>
            `;
            document.body.appendChild(popup);
            
            setTimeout(() => {
                popup.style.opacity = '0';
                popup.style.transition = 'opacity 0.3s';
                setTimeout(() => popup.remove(), 300);
            }, 3000);
        }

        // 创建烟花效果
        function createFireworks(count) {
            const container = elements.gameSection;
            
            for (let i = 0; i < count; i++) {
                const firework = document.createElement('div');
                const size = Math.random() * 40 + 20;
                const x = Math.random() * 100;
                const y = Math.random() * 60 + 20;
                
                // 与巴基斯坦国旗相关的随机颜色
                const colors = ['#006600', '#FFFFFF', '#003366', '#FFCC00'];
                const color = colors[Math.floor(Math.random() * colors.length)];
                
                firework.className = 'firework';
                firework.style.width = `${size}px`;
                firework.style.height = `${size}px`;
                firework.style.left = `${x}%`;
                firework.style.top = `${y}%`;
                firework.style.backgroundColor = color;
                
                container.appendChild(firework);
                
                // 动画结束后移除元素
                setTimeout(() => {
                    firework.remove();
                }, 1000);
            }
        }

        // 完成游戏
        function completeGame() {
            // 播放欢呼音效
            playCheerSound();
            
            // 角色胜利庆祝
            elements.gameCharacter.classList.add('cheering');
            showIngameDialogue('victory');
            
            // 显示最终分数
            const scoreElement = document.createElement('div');
            scoreElement.className = 'text-white text-center mb-6';
            scoreElement.innerHTML = `
                <p class="text-lg">Your Score</p>
                <p class="text-4xl font-bold">${gameState.score}</p>
            `;
            
            // 添加分享分数按钮
            const shareScoreBtn = document.createElement('button');
            shareScoreBtn.className = 'bg-[#1877F2] text-white px-6 py-3 rounded-full font-bold text-lg shadow-lg hover:bg-opacity-90 transition-all mb-6 transform hover:scale-105 active:scale-95';
            shareScoreBtn.innerHTML = '<i class="fa fa-facebook mr-2"></i> Share My Score';
            shareScoreBtn.addEventListener('click', () => {
                showToast(`Your score of ${gameState.score} has been shared!`);
            });
            
            // 添加元素到胜利屏幕
            const victoryContent = elements.victorySection.querySelector('div');
            victoryContent.insertBefore(scoreElement, victoryContent.firstChild);
            victoryContent.insertBefore(shareScoreBtn, elements.proceedToPhotoBtn);
            
            // 显示胜利屏幕
            setTimeout(() => {
                showSection(elements.victorySection);
            }, 2000);
        }

        // 处理照片上传
        function handlePhotoUpload(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            // 检查文件类型
            if (!file.type.startsWith('image/')) {
                showToast('Please upload an image file');
                return;
            }
            
            // 显示加载指示器
            const loader = document.createElement('div');
            loader.className = 'loader absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20';
            document.querySelector('#photo-upload-section .flex-grow').appendChild(loader);
            
            const reader = new FileReader();
            reader.onload = function(event) {
                // 移除加载指示器
                loader.remove();
                
                gameState.userPhoto = event.target.result;
                elements.userPhoto.src = gameState.userPhoto;
                
                // 重置照片位置和大小
                gameState.photoPosition = { x: 50, y: 50 };
                gameState.photoScale = 50;
                updatePhotoPosition();
                
                // 显示照片编辑部分
                showSection(elements.photoEditSection);
                
                // 更新用户名显示
                elements.usernameDisplay.textContent = gameState.username;
            };
            reader.readAsDataURL(file);
        }

        // 生成海报 - 保持用户调整的照片位置和大小
        function generatePoster() {
            // 显示加载指示器
            const loader = document.createElement('div');
            loader.className = 'loader absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 z-20 bg-black bg-opacity-50 p-4 rounded-full';
            document.querySelector('#photo-edit-section .flex-grow').appendChild(loader);
            
            // 模拟处理延迟
            setTimeout(() => {
                // 生成的海报中保持用户调整的照片位置和大小
                const posterHtml = `
                    <div class="relative w-full h-full">
                        <img src="assets/images/poster/poster-bg.png" alt="Poster background" class="w-full h-full object-cover">
                        <img src="${gameState.userPhoto}" alt="User photo" 
                            style="position: absolute; 
                                   width: ${gameState.photoScale}%; 
                                   aspect-ratio: 1/1;
                                   left: ${gameState.photoPosition.x}%; 
                                   top: ${gameState.photoPosition.y}%; 
                                   transform: translate(-50%, -50%);
                                   border: 4px solid white;
                                   box-shadow: 0 8px 24px rgba(0,0,0,0.3);">
                        <div class="absolute bottom-10 left-0 right-0 text-center text-white text-[clamp(1rem,3vw,1.5rem)] font-bold drop-shadow-lg">
                            ${gameState.username} wishes Pakistan a Happy Independence Day!
                        </div>
                    </div>
                `;
                
                elements.finalPoster.innerHTML = posterHtml;
                
                // 移除加载指示器并显示结果
                loader.remove();
                showSection(elements.posterResultSection);
            }, 800);
        }

        // 保存海报
        function savePoster() {
            showToast('Image saved to your gallery!');
        }

        // 分享海报
        function sharePoster() {
            showToast('Sharing to Facebook...');
            setTimeout(() => {
                showToast('Shared successfully!');
            }, 1000);
        }

        // 初始化游戏
        function init() {
            initEventListeners();
        }

        // 启动游戏
        window.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
    